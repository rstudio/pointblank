<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to the Pipeline Data Validation Workflow (VALID-II) • pointblank</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to the Pipeline Data Validation Workflow (VALID-II)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pointblank</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.12.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/pointblank.html">Get Started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Validation Workflows</h6></li>
    <li><a class="dropdown-item" href="../articles/validation_workflows.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-I.html">VALID-I: Data Quality Reporting</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-II.html">VALID-II: Pipeline Data Validation</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-III.html">VALID-III: Expectations in Unit Tests</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-IV.html">VALID-IV: Data Tests for Conditionals</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-V.html">VALID-V: Table Scan</a></li>
    <li><a class="dropdown-item" href="../articles/VALID-VI.html">VALID-VI: R Markdown Document Validation</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Information Management</h6></li>
    <li><a class="dropdown-item" href="../articles/INFO-1.html">Intro to Information Management</a></li>
    <li><a class="dropdown-item" href="../articles/INFO-2.html">Advanced Information Management</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/pointblank/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Introduction to the Pipeline Data Validation Workflow (VALID-II)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/pointblank/blob/main/vignettes/VALID-II.Rmd" class="external-link"><code>vignettes/VALID-II.Rmd</code></a></small>
      <div class="d-none name"><code>VALID-II.Rmd</code></div>
    </div>

    
    
<p><img src="images%2FVALID-II.svg" width="100%"></p>
<p>The second data validation workflow, <em>VALID-II: Pipeline Data
Validation</em>, somewhat simplifies the process for checking data
directly. There is no <em>agent</em> involved here and we instead call
validation functions directly on the data table objects. Because no
<em>agent</em>, there is no report, and the idea is that the side
effects are most important here. We can trigger warnings, raise errors,
or write out logs when exceeding specified failure thresholds. The data
just passes through the validation functions (some data in, the same
data out).</p>
<p>Where would we do this? When importing data, for instance, we could
pass the incoming data through a few validation functions, possibly with
customized threshold levels set (by default, any test units failing will
result in an error). We could also use a set of validation functions
further down the script on transformed data as a QA/QC measure. If bad
data quality might be ruinous for a downstream report (especially in an
automated context), it’s better to stop the process through
<strong>pointblank</strong> validation tests and get to the heart of the
matter. And, just like every workflow in <strong>pointblank</strong>,
the target table can be a data frame or tibble, a database table (a
<code>tbl_dbi</code> object), or a Spark DataFrame (a
<code>tbl_spark</code> object, by way of the <strong>sparklyr</strong>
package).</p>
<div class="section level2">
<h2 id="an-example-of-this-workflow">An Example of This Workflow<a class="anchor" aria-label="anchor" href="#an-example-of-this-workflow"></a>
</h2>
<p>Let’s adapt an example used in the <a href="../articles/VALID-I.html"><em>VALID-I: Data Quality Reporting
Workflow</em></a> article to the pipeline data validation workflow:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_table</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_is_posix.html">col_is_posix</a></span><span class="op">(</span><span class="va">date_time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_in_set.html">col_vals_in_set</a></span><span class="op">(</span><span class="va">f</span>, set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"mid"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_lt.html">col_vals_lt</a></span><span class="op">(</span><span class="va">a</span>, value <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_regex.html">col_vals_regex</a></span><span class="op">(</span><span class="va">b</span>, regex <span class="op">=</span> <span class="st">"^[0-9]-[a-z]{3}-[0-9]{3}$"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_between.html">col_vals_between</a></span><span class="op">(</span><span class="va">d</span>, left <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Exceedance of failed test units where values in `d` should have been between `0` and `5000`.</span></span>
<span><span class="co">## The `col_vals_between()` validation failed beyond the absolute threshold level (1).</span></span>
<span><span class="co">## * failure level (1) &gt;= failure threshold (1)</span></span></code></pre>
<p>In terms of the expressions used in the pipeline, you might notice
that the <code><a href="../reference/create_agent.html">create_agent()</a></code> and <code><a href="../reference/interrogate.html">interrogate()</a></code>
functions are absent. This is due to the secondary role of the
validation functions, where they can operate directly and immediately on
the data, acting as a sort of filter. If all validations in this
pipeline pass (i.e., there are no failing test units in any of the
validation steps), then the <code>small_table</code> data is returned.
Otherwise, as it’s currently written, a stoppage will occur on any such
failure.</p>
<p>As it turns out, the above validation pipeline did result in an
error. The stringent default threshold setting stops the evaluation of
the pipeline at the point of failure (one or more test units failing).
This, in turn, stops the running script (a key consideration if the
script is deployed and automatically running on some sort of schedule).
In this type of workflow we don’t need to define those functions,
<strong>pointblank</strong> will automatically do the sensible thing by
stopping evaluation and providing a stock message. So, in the first
instance of such a stoppage due to validation failing,
<strong>R</strong> scripts will stop at that point and <strong>R
Markdown</strong> documents will correspondingly cease to render.</p>
</div>
<div class="section level2">
<h2 id="modifying-the-behavior-of-validation-failures">Modifying the Behavior of Validation Failures<a class="anchor" aria-label="anchor" href="#modifying-the-behavior-of-validation-failures"></a>
</h2>
<p>There are ways to counteract the stopping behavior seen in the
previous example. In an <strong>R Markdown</strong> document, we could
set the chunk option <code>error = TRUE</code> where we might expect an
error to occur due to validation failure (allowing execution to continue
no matter what happens). That’s what was done for the
<code>small_table</code> example in this very document, giving us the
error message printed below the input. Another way is to disable
evaluation at the step level is to use the <code>active = FALSE</code>
option on every validation function that shouldn’t be evaluated. This
works for both <strong>R</strong> scripts and <strong>R
Markdown</strong> documents but it is quite different since we can’t
determine whether a validation passed or failed since it doesn’t
actually perform the check (it simply skips it). It is useful, however,
if you want to enable staged checks use data validations in a sort of
‘debug mode’ since global variables that are logical can be passed to
the <code>active</code> argument in specific validation functions.
Another strategy is to not <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code> but instead
<code>warn()</code>.</p>
<div class="section level3">
<h3 id="using-warn_on_fail-and-stop_on_fail-functions-to-generate-simple-action_levels">Using <code>warn_on_fail()</code> and <code>stop_on_fail()</code>
functions to generate simple <code>action_levels</code><a class="anchor" aria-label="anchor" href="#using-warn_on_fail-and-stop_on_fail-functions-to-generate-simple-action_levels"></a>
</h3>
<p>There are two helper functions that are convenient for this workflow:
<code><a href="../reference/action_levels.html">warn_on_fail()</a></code> and <code><a href="../reference/action_levels.html">stop_on_fail()</a></code>. These
functions return an <code>action_levels</code> object that either warns
or stops, doing so with informative warning or error messages. The
default failure threshold for each is set to <code>1</code>: one
<em>fail</em> unit means that the threshold for the <code>WARN</code> or
<code>FAIL</code> condition will be met. The <code><a href="../reference/action_levels.html">stop_on_fail()</a></code>
helper is (behind the scenes) applied by default when using validation
functions in the <em>VALID-II</em> workflow. So, the previous example is
exactly the same as this expanded form:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_table</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_is_posix.html">col_is_posix</a></span><span class="op">(</span></span>
<span>    <span class="va">date_time</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">stop_on_fail</a></span><span class="op">(</span>stop_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_in_set.html">col_vals_in_set</a></span><span class="op">(</span></span>
<span>    <span class="va">f</span>, set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"mid"</span>, <span class="st">"high"</span><span class="op">)</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">stop_on_fail</a></span><span class="op">(</span>stop_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_lt.html">col_vals_lt</a></span><span class="op">(</span></span>
<span>    <span class="va">a</span>, value <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">stop_on_fail</a></span><span class="op">(</span>stop_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_regex.html">col_vals_regex</a></span><span class="op">(</span></span>
<span>    <span class="va">b</span>, regex <span class="op">=</span> <span class="st">"^[0-9]-[a-z]{3}-[0-9]{3}$"</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">stop_on_fail</a></span><span class="op">(</span>stop_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_between.html">col_vals_between</a></span><span class="op">(</span></span>
<span>    <span class="va">d</span>, left <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">stop_on_fail</a></span><span class="op">(</span>stop_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Exceedance of failed test units where values in `d` should have been between `0` and `5000`.</span></span>
<span><span class="co">## The `col_vals_between()` validation failed beyond the absolute threshold level (1).</span></span>
<span><span class="co">## * failure level (1) &gt;= failure threshold (1)</span></span></code></pre>
<p>If we want to instead issue warnings, perhaps with less stringent
failure thresholds in certain steps, the <code><a href="../reference/action_levels.html">warn_on_fail()</a></code>
function provides a simple way to express this.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_table</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_is_posix.html">col_is_posix</a></span><span class="op">(</span></span>
<span>    <span class="va">date_time</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">warn_on_fail</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_in_set.html">col_vals_in_set</a></span><span class="op">(</span></span>
<span>    <span class="va">f</span>, set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"mid"</span>, <span class="st">"high"</span><span class="op">)</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">warn_on_fail</a></span><span class="op">(</span>warn_at <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_lt.html">col_vals_lt</a></span><span class="op">(</span></span>
<span>    <span class="va">a</span>, value <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">warn_on_fail</a></span><span class="op">(</span>warn_at <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_regex.html">col_vals_regex</a></span><span class="op">(</span></span>
<span>    <span class="va">b</span>, regex <span class="op">=</span> <span class="st">"^[0-9]-[a-z]{3}-[0-9]{3}$"</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">warn_on_fail</a></span><span class="op">(</span>warn_at <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_between.html">col_vals_between</a></span><span class="op">(</span></span>
<span>    <span class="va">d</span>, left <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>    actions <span class="op">=</span> <span class="fu"><a href="../reference/action_levels.html">warn_on_fail</a></span><span class="op">(</span>warn_at <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Exceedance of failed test units where values in `d` should have been between `0` and `5000`.</span></span>
<span><span class="co">## The `col_vals_between()` validation failed beyond the absolute threshold level (1).</span></span>
<span><span class="co">## * failure level (1) &gt;= failure threshold (1)</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 13 × 8</span></span></span>
<span><span class="co">##    date_time           date           a b             c      d e     f    </span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 2016-01-04 <span style="color: #949494;">11:00:00</span> 2016-01-04     2 1-bcd-345     3  <span style="text-decoration: underline;">3</span>423. TRUE  high </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 2016-01-04 <span style="color: #949494;">00:32:00</span> 2016-01-04     3 5-egh-163     8 <span style="text-decoration: underline;">10</span>000. TRUE  low  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 2016-01-05 <span style="color: #949494;">13:32:00</span> 2016-01-05     6 8-kdg-938     3  <span style="text-decoration: underline;">2</span>343. TRUE  high </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 2016-01-06 <span style="color: #949494;">17:23:00</span> 2016-01-06     2 5-jdo-903    <span style="color: #BB0000;">NA</span>  <span style="text-decoration: underline;">3</span>892. FALSE mid  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 2016-01-09 <span style="color: #949494;">12:36:00</span> 2016-01-09     8 3-ldm-038     7   284. TRUE  low  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 2016-01-11 <span style="color: #949494;">06:15:00</span> 2016-01-11     4 2-dhe-923     4  <span style="text-decoration: underline;">3</span>291. TRUE  mid  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 2016-01-15 <span style="color: #949494;">18:46:00</span> 2016-01-15     7 1-knw-093     3   843. TRUE  high </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 2016-01-17 <span style="color: #949494;">11:27:00</span> 2016-01-17     4 5-boe-639     2  <span style="text-decoration: underline;">1</span>036. FALSE low  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 2016-01-20 <span style="color: #949494;">04:30:00</span> 2016-01-20     3 5-bce-642     9   838. FALSE high </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 2016-01-20 <span style="color: #949494;">04:30:00</span> 2016-01-20     3 5-bce-642     9   838. FALSE high </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> 2016-01-26 <span style="color: #949494;">20:07:00</span> 2016-01-26     4 2-dmx-010     7   834. TRUE  low  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> 2016-01-28 <span style="color: #949494;">02:51:00</span> 2016-01-28     2 7-dmx-010     8   108. FALSE low  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> 2016-01-30 <span style="color: #949494;">11:23:00</span> 2016-01-30     1 3-dka-303    <span style="color: #BB0000;">NA</span>  <span style="text-decoration: underline;">2</span>230. TRUE  high</span></span></code></pre>
<p>While <code><a href="../reference/action_levels.html">warn_on_fail()</a></code> and <code><a href="../reference/action_levels.html">stop_on_fail()</a></code> are
handy ways to generate <code>action_levels</code> objects for the
<code>actions</code> argument in every validation function, it doesn’t
provide a way to specify any actions. For that, we’ll need to use the
<code><a href="../reference/action_levels.html">action_levels()</a></code> function directly.</p>
</div>
<div class="section level3">
<h3 id="using-action_levels-for-more-control">Using <code>action_levels()</code> for More Control<a class="anchor" aria-label="anchor" href="#using-action_levels-for-more-control"></a>
</h3>
<p>The <code><a href="../reference/action_levels.html">action_levels()</a></code> function can be as useful here as it
is for the <a href="../articles/VALID-I.html"><strong>VALID-I</strong></a> workflow
with an <em>agent</em>. The function creates an
<code>action_levels</code> object which can have two roles: (1)
specification of threshold failure levels for entering certain
conditions (<code>WARN</code>, <code>STOP</code>, and
<code>NOTIFY</code>), and (2) setting of actions (i.e., function calls
to invoke) when entering a specific condition. The <code>fns</code>
argument of <code><a href="../reference/action_levels.html">action_levels()</a></code> allows us to define those
custom functions that are evaluated upon entering each of the three
states (and this acts on the ‘step’ level, per each validation
function).</p>
<p>Compared to the <a href="../articles/VALID-I.html"><strong>VALID-I</strong></a> workflow,
which deals more with reporting, having actions triggered by failures in
the <strong>VALID-II</strong> workflow is probably more useful and
important. We can imagine a situation where an <strong>R</strong> script
is deployed with data validation interspersed throughout. Depending on
the deployment, we may desire a hard stop (affecting the downstream
components), or, we may want a softer approach with warning and
logging.</p>
<p>Let’s try a hybrid approach where each of three available conditions
have failure threshold levels set and an associated function to invoke.
The functions to invoke at each condition can be whatever makes sense
for the workflow (i.e., we don’t have to issue warnings in the
<code>WARN</code> condition if we want something else). Here, we will
use a <code><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning()</a></code> for <code>WARN</code>, a
<code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code> for <code>STOP</code>, and a logging function
(<code><a href="../reference/log4r_step.html">log4r_step()</a></code>) for <code>NOTIFY</code>. Here’s how we might
create such an <code>action_levels</code> object with
<code><a href="../reference/action_levels.html">action_levels()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">al</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/action_levels.html">action_levels</a></span><span class="op">(</span></span>
<span>    warn_at <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    stop_at <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    notify_at <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      warn <span class="op">=</span> <span class="op">~</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"WARN threshold exceeded."</span><span class="op">)</span>,</span>
<span>      stop <span class="op">=</span> <span class="op">~</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"STOP threshold exceeded."</span><span class="op">)</span>,</span>
<span>      notify <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/log4r_step.html">log4r_step</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Once we assigned the <code>action_levels</code> to an object (in this
case, as <code>al</code>) we can print it to get a summary of the
settings.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">al</span></span></code></pre></div>
<pre><code><span><span class="co">## -- The `action_levels` settings</span></span>
<span><span class="co">## WARN failure threshold of 0.1 of all test units.</span></span>
<span><span class="co">## \fns\ ~ warning("WARN threshold exceeded.")</span></span>
<span><span class="co">## STOP failure threshold of 0.2 of all test units.</span></span>
<span><span class="co">## \fns\ ~ stop("STOP threshold exceeded.")</span></span>
<span><span class="co">## NOTIFY failure threshold of 0.3 of all test units.</span></span>
<span><span class="co">## \fns\ ~ log4r_step(x)</span></span>
<span><span class="co">## ----</span></span></code></pre>
<p>Finally, we will apply this object to every validation function call
in the expression (changed slightly to result in more test units
failing).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_table</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_is_posix.html">col_is_posix</a></span><span class="op">(</span><span class="va">date_time</span>, actions <span class="op">=</span> <span class="va">al</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_in_set.html">col_vals_in_set</a></span><span class="op">(</span><span class="va">f</span>, set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"mid"</span><span class="op">)</span>, actions <span class="op">=</span> <span class="va">al</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_lt.html">col_vals_lt</a></span><span class="op">(</span><span class="va">a</span>, value <span class="op">=</span> <span class="fl">7</span>, actions <span class="op">=</span> <span class="va">al</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_regex.html">col_vals_regex</a></span><span class="op">(</span><span class="va">b</span>, regex <span class="op">=</span> <span class="st">"^[0-9]-[a-w]{3}-[2-9]{3}$"</span>, actions <span class="op">=</span> <span class="va">al</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/col_vals_between.html">col_vals_between</a></span><span class="op">(</span><span class="va">d</span>, left <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="fl">4000</span>, actions <span class="op">=</span> <span class="va">al</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in rlang::eval_tidy(.): WARN threshold exceeded.</span></span></code></pre>
<pre><code><span><span class="co">## Error in rlang::eval_tidy(.): STOP threshold exceeded.</span></span></code></pre>
<p>In addition to an error and a warning, the <code><a href="../reference/log4r_step.html">log4r_step()</a></code>
function used for the <code>NOTIFY</code> condition generates, in this
case, a new <code>"pb_log_file"</code> text file for logs. We can
examine it with <code><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines()</a></code>; it has a single entry that
relates to <code>Step 1</code> (the <code><a href="../reference/col_vals_in_set.html">col_vals_in_set()</a></code>
step):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"pb_log_file"</span><span class="op">)</span></span></code></pre></div>
<pre><code>FATAL [2020-11-09 00:23:48] Step 1 exceeded the NOTIFY failure threshold (f_failed = 0.46154) ['col_vals_in_set']</code></pre>
<p>The <code><a href="../reference/log4r_step.html">log4r_step()</a></code> function offered by
<strong>pointblank</strong> is shown in examples and explained in more
detail in the <a href="../articles/VALID-I.html"><em>VALID-I: Data
Quality Reporting Workflow</em></a> article.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Richard Iannone, Mauricio Vargas, June Choe.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
